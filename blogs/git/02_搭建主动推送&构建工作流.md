---
title: 博客自动化部署方案演进
date: 2025-08-05
categories:
 - git
tags:
 - git
sidebar: 'auto'
---

# 从 GitHub Actions 自动构建到 crontab 定时推送：博客自动化部署方案演进

在个人博客系统的开发和维护过程中，自动化部署是一个关键环节。本文将详细介绍从使用 GitHub Actions 自动构建到配置 crontab 定时推送的演进过程，帮助你构建一个更加智能和可靠的博客发布系统。

## 1. 初始方案：GitHub Actions 自动构建

最初，我们采用了 GitHub Actions 来实现博客的自动化部署。这种方式通过在代码推送到仓库时自动触发构建和部署流程。

### 1.1 配置 Personal Access Token

为了使 GitHub Actions 能够部署代码到外部仓库，我们需要配置 Personal Access Token：

1. 登录 GitHub，进入 Settings > Developer settings > Personal access tokens > Tokens (classic)
2. 点击 "Generate new token (classic)"
3. 填写描述 (如 "Blog Deployment Token")，选择过期时间
4. 仅勾选 `public_repo` 权限
5. 点击 "Generate token"，复制生成的 token 并妥善保存

### 1.2 在仓库中配置 Secret

1. 进入博客仓库的 Settings > Secrets and variables > Actions
2. 删除 `DEPLOY_KEY`（如果存在）
3. 点击 "New repository secret"
4. 名称输入 `PERSONAL_TOKEN`，值为复制的 token

### 1.3 更新 GitHub Actions 工作流

在 `.github/workflows/daily-deploy.yml` 中配置：

```yaml
name: Deploy to GitHub Pages

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build
        run: yarn build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.PERSONAL_TOKEN }}
          external_repository: your-username/your-username.github.io
          publish_dir: ./public
          publish_branch: master
```

## 2. 演进方案：crontab 定时推送

随着需求的发展，我们希望实现更加自动化的部署流程，于是转向了使用本地 crontab 定时推送的方案。

### 2.1 crontab 基本概念

### 2.1.1 什么是 cron 和 crontab

crontab（cron table 的缩写）是类 Unix 系统下的定时任务管理工具，允许用户在指定的时间自动执行预设的命令或脚本。它是系统管理员和开发人员实现自动化任务的重要工具。

cron 是类 Unix 系统下的一个守护进程，用于在后台定期执行命令。它通常在系统启动时自动运行，并根据配置的时间表执行各种任务。

crontab 是管理 cron 任务的命令行工具，允许用户创建、编辑、查看和删除定时任务。每个用户都可以拥有自己的 crontab 文件，系统也有全局的 crontab 文件。

常用时间表达式示例：
- `0 10 * * *` - 每天上午 10:00 执行
- `0 10 * * 1-5` - 每个工作日（周一到周五）上午 10:00 执行
- `0 2 1 * *` - 每月 1 号凌晨 2:00 执行
- `*/5 * * * *` - 每隔 5 分钟执行一次
- `@reboot` - 系统启动时执行

### 2.2 创建自动部署脚本

首先，创建一个适用于 zsh 环境的自动部署脚本 `auto-deploy.sh`：

```bash
#!/usr/bin/env zsh

# 自动部署脚本 (适用于 zsh)
# 确保脚本抛出遇到的错误
set -e

# 获取脚本所在目录
local script_dir="${0:a:h}"
cd "$script_dir"

# 输出当前时间
echo "开始提交博客更改: $(date)"

# 确保使用正确的 Node.js 和 yarn
export PATH="/usr/local/bin:$PATH"

# 生成静态文件
echo "正在构建博客..."
yarn build

# 添加并提交更改到博客仓库
git add -A
git commit -m "Auto commit at $(date)" || echo "没有需要提交的更改"

# 推送到远程仓库以触发 GitHub Actions
git push origin master

echo "提交完成: $(date)"
echo "GitHub Actions 将自动触发部署"
```

### 2.3 设置脚本执行权限

```bash
chmod +x /path/to/your/blog/auto-deploy.sh
```

### 2.4 配置 crontab 定时任务

使用 `crontab -e` 命令编辑定时任务：

```bash
# 设置环境变量
SHELL=/bin/zsh
PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin

# 工作日上午 10 点自动部署博客（周一到周五）
0 10 * * 1-5 /path/to/your/blog/auto-deploy.sh >> /path/to/your/blog/deploy.log 2>&1
```

### 2.5 验证配置

保存并退出编辑器后，可以通过以下命令验证：

```bash
crontab -l
```

## 3. 两种方案的对比

### 3.1 GitHub Actions 方案优势

- **环境隔离**：在标准化的虚拟环境中运行，不受本地环境影响
- **可视化监控**：可以通过 GitHub 界面查看执行状态和日志
- **触发灵活**：支持推送触发、手动触发和定时触发等多种方式
- **安全性**：Secrets 管理机制更加安全

### 3.2 crontab 方案优势

- **完全自动化**：无需手动推送代码，系统自动完成构建和推送
- **本地控制**：完全由本地机器控制，不依赖外部服务
- **资源节省**：不需要 GitHub Actions 的运行时间
- **灵活性**：可以根据本地环境定制更复杂的逻辑

## 4. 最佳实践建议

1. **备份策略**：无论采用哪种方案，都要确保代码有备份
2. **日志监控**：配置完善的日志记录机制，便于问题排查
3. **错误处理**：在脚本中添加适当的错误处理逻辑
4. **权限管理**：合理设置 Personal Access Token 的权限和有效期
5. **测试验证**：在正式使用前充分测试自动化流程

## 5. 总结

从 GitHub Actions 自动构建到 crontab 定时推送的演进，体现了自动化部署方案的不断优化。两种方案各有优势，可以根据实际需求选择合适的方案。对于个人博客项目，crontab 定时推送方案提供了更高的自动化程度和本地控制能力，是一个值得推荐的选择。

通过合理配置 Personal Access Token 和 crontab 定时任务，我们可以构建一个稳定、可靠的博客自动化发布系统，让内容创作更加专注，无需过多关注部署细节。